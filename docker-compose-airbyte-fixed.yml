version: '3.8'

services:
  # Airbyte Database
  airbyte-db:
    image: postgres:13-alpine
    container_name: bentley-airbyte-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: docker
      POSTGRES_PASSWORD: docker
      POSTGRES_DB: airbyte
    volumes:
      - airbyte_db:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  # Airbyte Bootloader
  airbyte-bootloader:
    image: airbyte/bootloader:0.63.15
    container_name: bentley-airbyte-bootloader
    environment:
      - AIRBYTE_VERSION=0.63.15
      - DATABASE_PASSWORD=docker
      - DATABASE_URL=jdbc:postgresql://airbyte-db:5432/airbyte
      - DATABASE_USER=docker
    depends_on:
      - airbyte-db
    command: ./wait-for-it.sh airbyte-db:5432 -- bootloader

  # Airbyte Temporal
  airbyte-temporal:
    image: temporalio/auto-setup:1.22.0
    container_name: bentley-airbyte-temporal
    restart: unless-stopped
    ports:
      - "7233:7233"
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=docker
      - POSTGRES_PWD=docker
      - POSTGRES_SEEDS=airbyte-db
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
    volumes:
      - ./temporal:/etc/temporal/config/dynamicconfig
    depends_on:
      - airbyte-db

  # Airbyte Server (API)
  airbyte-server:
    image: airbyte/server:0.63.15
    container_name: bentley-airbyte-server
    restart: unless-stopped
    environment:
      - AIRBYTE_VERSION=0.63.15
      - CONFIG_ROOT=/data
      - DATABASE_PASSWORD=docker
      - DATABASE_URL=jdbc:postgresql://airbyte-db:5432/airbyte
      - DATABASE_USER=docker
      - TEMPORAL_HOST=airbyte-temporal:7233
      - TRACKING_STRATEGY=logging
      - WORKSPACE_ROOT=/tmp/workspace
      - WORKER_ENVIRONMENT=docker
      - LOCAL_ROOT=/tmp/airbyte_local
      - WEBAPP_URL=http://localhost:8000
      - AUTO_DETECT_SCHEMA=true
    ports:
      - "8001:8001"
    volumes:
      - workspace:/tmp/workspace
      - data:/data
      - local_root:/tmp/airbyte_local
    depends_on:
      airbyte-bootloader:
        condition: service_completed_successfully

  # Airbyte Web UI  
  airbyte-webapp:
    image: airbyte/webapp:0.63.15
    container_name: bentley-airbyte-webapp
    restart: unless-stopped
    ports:
      - "8000:80"
    environment:
      - AIRBYTE_VERSION=0.63.15
      - API_URL=/api/v1/
      - CONNECTOR_BUILDER_API_URL=/connector-builder-api
      - INTERNAL_API_HOST=airbyte-server:8001
      - CONNECTOR_BUILDER_API_HOST=airbyte-connector-builder-server:80
      - TRACKING_STRATEGY=logging
    depends_on:
      - airbyte-server

  # Airbyte Worker
  airbyte-worker:
    image: airbyte/worker:0.63.15
    container_name: bentley-airbyte-worker
    restart: unless-stopped
    environment:
      - AIRBYTE_VERSION=0.63.15
      - AUTO_DETECT_SCHEMA=true
      - CONFIG_ROOT=/data
      - DATABASE_PASSWORD=docker
      - DATABASE_URL=jdbc:postgresql://airbyte-db:5432/airbyte
      - DATABASE_USER=docker
      - DEPLOYMENT_MODE=OSS
      - LOCAL_DOCKER_MOUNT=/tmp/airbyte_local
      - LOCAL_ROOT=/tmp/airbyte_local
      - SECRET_PERSISTENCE=TESTING_CONFIG_DB_TABLE
      - TEMPORAL_HOST=airbyte-temporal:7233
      - TRACKING_STRATEGY=logging
      - WEBAPP_URL=http://localhost:8000
      - WORKER_ENVIRONMENT=docker
      - WORKSPACE_ROOT=/tmp/workspace
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - workspace:/tmp/workspace:rw
      - local_root:/tmp/airbyte_local:rw
    depends_on:
      - airbyte-server

  # Airbyte Connector Builder Server
  airbyte-connector-builder-server:
    image: airbyte/connector-builder-server:0.63.15
    container_name: bentley-airbyte-connector-builder-server
    restart: unless-stopped
    ports:
      - "80"
    environment:
      - AIRBYTE_VERSION=0.63.15
      - CDK_VERSION=0.63.15
      - CONNECTOR_BUILDER_SERVER_API_HOST=0.0.0.0
    depends_on:
      - airbyte-server

volumes:
  airbyte_db:
  workspace:
  data:
  local_root:

networks:
  default:
    name: airbyte-network